name: Claude Code (DeepSeek)

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened]
  pull_request:
    types: [opened]

jobs:
  claude:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if @claude is mentioned
        id: check_mention
        run: |
          MENTIONED="false"

          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            BODY="${{ github.event.comment.body }}"
          elif [ "${{ github.event_name }}" == "issues" ]; then
            BODY="${{ github.event.issue.body }}"
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            BODY="${{ github.event.pull_request.body }}"
          fi

          if echo "$BODY" | grep -qi "@claude"; then
            MENTIONED="true"
            echo "@claude found in content"
          else
            echo "@claude NOT found, skipping..."
          fi

          echo "mentioned=${MENTIONED}" >> $GITHUB_OUTPUT

          if [ "$MENTIONED" == "false" ]; then
            exit 1  # Skip remaining steps
          fi

      - name: Install Claude Code
        if: steps.check_mention.outputs.mentioned == 'true'
        run: |
          npm install -g claude-code
          echo "Claude installed at: $(which claude)"

      - name: Setup GitHub MCP
        if: steps.check_mention.outputs.mentioned == 'true'
        run: |
          mkdir -p ~/.claude

          cat > ~/.claude.json << 'EOF'
          {
            "mcpServers": {
              "github": {
                "command": "npx",
                "args": ["-y", "@modelcontextprotocol/server-github"],
                "env": {
                  "GITHUB_PERSONAL_ACCESS_TOKEN": "${{ secrets.GITHUB_TOKEN }}"
                }
              }
            }
          }
          EOF

      - name: Get context
        id: context
        if: steps.check_mention.outputs.mentioned == 'true'
        run: |
          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
            echo "type=issue" >> $GITHUB_OUTPUT
            echo "comment_body=${{ github.event.comment.body }}" >> $GITHUB_OUTPUT
            echo "comment_author=${{ github.event.comment.user.login }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "issues" ]; then
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
            echo "type=issue" >> $GITHUB_OUTPUT
            echo "comment_body=${{ github.event.issue.body }}" >> $GITHUB_OUTPUT
            echo "comment_author=${{ github.event.issue.user.login }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "type=pr" >> $GITHUB_OUTPUT
            echo "comment_body=${{ github.event.pull_request.body }}" >> $GITHUB_OUTPUT
            echo "comment_author=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT
          fi

      - name: Run Claude Code
        if: steps.check_mention.outputs.mentioned == 'true'
        env:
          ANTHROPIC_BASE_URL: https://api.deepseek.com/anthropic
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.DEEPSEEK_API_KEY }}
          ANTHROPIC_MODEL: deepseek-chat
          CLAUDE_CODE_DISABLE_NON_ESSENTIAL_TRAFFIC: 1
        run: |
          ISSUE_TYPE="${{ steps.context.outputs.type }}"
          ISSUE_NUMBER="${{ steps.context.outputs.number }}"
          COMMENT_BODY="${{ steps.context.outputs.comment_body }}"
          COMMENT_AUTHOR="${{ steps.context.outputs.comment_author }}"

          cat > /tmp/prompt.txt << EOF
          You are Claude, helping with GitHub repo ${{ github.repository }}.

          Issue/PR: #${ISSUE_NUMBER}
          Author: @${COMMENT_AUTHOR}
          Comment: ${COMMENT_BODY}

          Read the issue using GitHub MCP and provide a helpful, concise response.
          EOF

          claude --prompt "$(< /tmp/prompt.txt)" 2>&1 | tee /tmp/output.txt

      - name: Post response
        if: steps.check_mention.outputs.mentioned == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('/tmp/output.txt', 'utf8');
            const issueNumber = '${{ steps.context.outputs.number }}';

            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: issueNumber,
              body: `**@claude (DeepSeek)**\n\n${output}\n\n---\n*Generated via Claude Code*`
            });
