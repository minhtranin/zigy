name: Claude

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened]
  pull_request:
    types: [opened]

jobs:
  claude:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if @claude is mentioned
        id: check_mention
        run: |
          MENTIONED="false"

          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            BODY="${{ github.event.comment.body }}"
          elif [ "${{ github.event_name }}" == "issues" ]; then
            BODY="${{ github.event.issue.body }}"
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            BODY="${{ github.event.pull_request.body }}"
          fi

          if echo "$BODY" | grep -qi "@claude"; then
            MENTIONED="true"
            echo "@claude found in content"
          else
            echo "@claude NOT found, skipping..."
          fi

          echo "mentioned=${MENTIONED}" >> $GITHUB_OUTPUT

          if [ "$MENTIONED" == "false" ]; then
            exit 1  # Skip remaining steps
          fi

      - name: Install Claude Code
        if: steps.check_mention.outputs.mentioned == 'true'
        run: |
          npm install -g @anthropic-ai/claude-code
          echo "Claude installed at: $(which claude)"

      - name: Setup GitHub MCP
        if: steps.check_mention.outputs.mentioned == 'true'
        run: |
          mkdir -p ~/.claude

          cat > ~/.claude.json << 'EOF'
          {
            "mcpServers": {
              "github": {
                "command": "npx",
                "args": ["-y", "@modelcontextprotocol/server-github"],
                "env": {
                  "GITHUB_PERSONAL_ACCESS_TOKEN": "${{ secrets.GITHUB_TOKEN }}"
                }
              }
            }
          }
          EOF

      - name: Get context
        id: context
        if: steps.check_mention.outputs.mentioned == 'true'
        run: |
          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
            echo "type=issue" >> $GITHUB_OUTPUT
            {
              echo "title<<EOF"
              echo "${{ github.event.issue.title }}"
              echo "EOF"
            } >> $GITHUB_OUTPUT
            echo "state=${{ github.event.issue.state }}" >> $GITHUB_OUTPUT
            {
              echo "comment_body<<EOF"
              echo "${{ github.event.comment.body }}"
              echo "EOF"
            } >> $GITHUB_OUTPUT
            echo "comment_author=${{ github.event.comment.user.login }}" >> $GITHUB_OUTPUT
            {
              echo "trigger_comment<<EOF"
              echo "${{ github.event.comment.body }}"
              echo "EOF"
            } >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "issues" ]; then
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
            echo "type=issue" >> $GITHUB_OUTPUT
            {
              echo "title<<EOF"
              echo "${{ github.event.issue.title }}"
              echo "EOF"
            } >> $GITHUB_OUTPUT
            echo "state=${{ github.event.issue.state }}" >> $GITHUB_OUTPUT
            {
              echo "comment_body<<EOF"
              echo "${{ github.event.issue.body }}"
              echo "EOF"
            } >> $GITHUB_OUTPUT
            echo "comment_author=${{ github.event.issue.user.login }}" >> $GITHUB_OUTPUT
            {
              echo "trigger_comment<<EOF"
              echo "${{ github.event.issue.body }}"
              echo "EOF"
            } >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "type=pr" >> $GITHUB_OUTPUT
            {
              echo "title<<EOF"
              echo "${{ github.event.pull_request.title }}"
              echo "EOF"
            } >> $GITHUB_OUTPUT
            echo "state=${{ github.event.pull_request.state }}" >> $GITHUB_OUTPUT
            {
              echo "comment_body<<EOF"
              echo "${{ github.event.pull_request.body }}"
              echo "EOF"
            } >> $GITHUB_OUTPUT
            echo "comment_author=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT
            {
              echo "trigger_comment<<EOF"
              echo "${{ github.event.pull_request.body }}"
              echo "EOF"
            } >> $GITHUB_OUTPUT
          fi

      - name: Run Claude Code
        if: steps.check_mention.outputs.mentioned == 'true'
        env:
          ANTHROPIC_BASE_URL: https://api.deepseek.com/anthropic
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.DEEPSEEK_API_KEY }}
          ANTHROPIC_MODEL: deepseek-chat
          CLAUDE_CODE_DISABLE_NON_ESSENTIAL_TRAFFIC: 1
        run: |
          ISSUE_TYPE="${{ steps.context.outputs.type }}"
          ISSUE_NUMBER="${{ steps.context.outputs.number }}"
          ISSUE_TITLE="${{ steps.context.outputs.title }}"
          ISSUE_STATE="${{ steps.context.outputs.state }}"
          COMMENT_BODY="${{ steps.context.outputs.comment_body }}"
          COMMENT_AUTHOR="${{ steps.context.outputs.comment_author }}"
          TRIGGER_COMMENT="${{ steps.context.outputs.trigger_comment }}"
          REPO="${{ github.repository }}"
          EVENT_TYPE="${{ github.event_name }}"

          # Build detailed system prompt
          cat > /tmp/prompt.txt << SYSTEMEOF
          You are Claude, an AI assistant designed to help with GitHub issues and pull requests. Think carefully as you analyze the context and respond appropriately.

          Here's the context for your current task:

          <formatted_context>
          Issue Title: ${ISSUE_TITLE}
          Issue State: ${ISSUE_STATE}
          Repository: ${REPO}
          Event Type: ${EVENT_TYPE}
          </formatted_context>

          <trigger_comment>
          ${TRIGGER_COMMENT}
          </trigger_comment>

          <comment_author>
          @${COMMENT_AUTHOR}
          </comment_author>

          Your task is to:
          1. Read the full issue using GitHub MCP tools (mcp__github__get_issue, mcp__github__get_issue_comments, etc.)
          2. Understand what the user is asking for
          3. Provide helpful, concise responses
          4. If code changes are needed, explain what should be done

          Important guidelines:
          - Be friendly and helpful
          - Keep responses concise but complete
          - Use code blocks for code examples
          - Reference specific files with paths when applicable
          - If you don't know something, be honest about it
          SYSTEMEOF

          claude "$(< /tmp/prompt.txt)" 2>&1 | tee /tmp/output.txt

      - name: Post response
        if: steps.check_mention.outputs.mentioned == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('/tmp/output.txt', 'utf8');
            const issueNumber = '${{ steps.context.outputs.number }}';

            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: issueNumber,
              body: `**@claude**\n\n${output}\n\n---\n*Generated via [Claude Code](https://claude.com/claude-code) | [View job run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*`
            });
